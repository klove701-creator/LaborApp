<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 관리</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>사용자 관리</h1>
            <div class="header-info">
                <a href="{{ url_for('admin_dashboard') }}" class="back-btn">← 대시보드로</a>
                <a href="{{ url_for('logout') }}" class="logout-btn">로그아웃</a>
            </div>
        </div>

        <!-- 새 사용자 생성 섹션 -->
        <div class="create-user-section">
            <h2>새 사용자 생성</h2>
            <form method="POST" action="{{ url_for('create_user') }}" class="create-form">
                <div class="user-form-grid">
                    <div class="form-group">
                        <label for="username">사용자 ID:</label>
                        <input type="text" id="username" name="username" placeholder="예: kim123" required class="user-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">비밀번호:</label>
                        <input type="password" id="password" name="password" placeholder="비밀번호 입력" required class="user-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="role">권한:</label>
                        <select id="role" name="role" class="role-select" onchange="toggleProjects()">
                            <option value="user">사용자</option>
                            <option value="admin">관리자</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="project-section">
                    <label>프로젝트 권한 (사용자인 경우):</label>
                    {% if available_projects %}
                    <div class="projects-checkbox-grid">
                        {% for project in available_projects %}
                        <label class="project-checkbox">
                            <input type="checkbox" name="projects" value="{{ project }}">
                            <span class="checkmark"></span>
                            {{ project }}
                        </label>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="no-projects">등록된 프로젝트가 없습니다. <a href="{{ url_for('admin_projects') }}">프로젝트 관리</a>에서 먼저 생성해주세요.</p>
                    {% endif %}
                </div>
                
                <button type="submit" class="create-btn">사용자 생성</button>
            </form>
        </div>

        <!-- 기존 사용자 목록 -->
        <div class="users-list-section">
            <h2>기존 사용자 ({{ users|length }}명)</h2>
            <div class="users-table-wrapper">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>사용자 ID</th>
                            <th>권한</th>
                            <th>할당 프로젝트</th>
                            <th>상태</th>
                            <th>생성일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_id, user_data in users.items() %}
                        <tr class="{% if user_data.get('status', 'active') == 'inactive' %}inactive-row{% endif %}">
                            <td class="user-id">
                                {{ user_id }}
                                {% if user_id == 'admin' %}
                                <span class="system-badge">시스템</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="role-badge role-{{ user_data.role }}">
                                    {% if user_data.role == 'admin' %}관리자{% else %}사용자{% endif %}
                                </span>
                            </td>
                            <td class="projects-cell">
                                {% if user_data.role == 'admin' %}
                                    <span class="all-access">전체 접근</span>
                                {% elif user_data.get('projects') %}
                                    {% for project in user_data.projects %}
                                    <span class="project-tag">{{ project }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="no-access">미할당</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ user_data.get('status', 'active') }}">
                                    {% if user_data.get('status', 'active') == 'active' %}활성{% else %}비활성{% endif %}
                                </span>
                            </td>
                            <td>{{ user_data.get('created_date', '미상') }}</td>
                            <td class="actions-cell">
                                {% if user_id != 'admin' %}
                                    <div class="action-buttons">
                                        <a href="{{ url_for('edit_user', username=user_id) }}" class="edit-btn">수정</a>
                                        <button class="toggle-btn" onclick="toggleUserStatus('{{ user_id }}')">
                                            {% if user_data.get('status', 'active') == 'active' %}비활성화{% else %}활성화{% endif %}
                                        </button>
                                        {% if user_id != session.username %}
                                        <button class="delete-btn" onclick="deleteUser('{{ user_id }}')">삭제</button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="protected-text">보호된 계정</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function toggleProjects() {
            const roleSelect = document.getElementById('role');
            const projectSection = document.getElementById('project-section');
            
            if (roleSelect.value === 'admin') {
                projectSection.style.display = 'none';
            } else {
                projectSection.style.display = 'block';
            }
        }

        function deleteUser(userId) {
            if (confirm(`"${userId}" 사용자를 삭제하시겠습니까?\n\n⚠️ 주의: 삭제된 사용자는 로그인할 수 없습니다.`)) {
                window.location.href = `/admin/users/delete/${userId}`;
            }
        }

        function toggleUserStatus(userId) {
            window.location.href = `/admin/users/toggle-status/${userId}`;
        }

        // 페이지 로드 시 초기 설정
        document.addEventListener('DOMContentLoaded', function() {
            toggleProjects();
        });
    </script>
</body>
</html>