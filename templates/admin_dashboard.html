<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- 상단 현장 카드 4열 그리드 + 신호등 + 테이블 막대 + 관리메뉴 5열 -->
    <style>
      /* 상단 현장 그리드 */
      .site-grid{
        display:grid;
        grid-template-columns:repeat(4, minmax(0,1fr));
        gap:16px;
        margin-bottom:24px;
      }
      @media (max-width:1200px){ .site-grid{ grid-template-columns:repeat(3,1fr);} }
      @media (max-width:900px){  .site-grid{ grid-template-columns:repeat(2,1fr);} }
      @media (max-width:600px){  .site-grid{ grid-template-columns:1fr; } }

      /* 카드: a 링크로 클릭 가능 */
      .site-card{
        display:block;
        background:#1f2937;
        border:1px solid #374151;
        border-radius:14px;
        padding:16px;
        box-shadow:0 6px 20px rgba(0,0,0,.25);
        min-height:96px;
        text-decoration:none;       /* 링크 밑줄 제거 */
        color:inherit;               /* 글자색 상속 */
        transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease, opacity .2s;
      }
      .site-card:hover{
        transform:translateY(-1px);
        box-shadow:0 10px 24px rgba(0,0,0,.35);
        border-color:#4b5563;
      }
      .site-card.inactive{ opacity:.7; pointer-events:none; } /* 비활성 클릭 금지 */

      .site-title{
        font-weight:700;
        font-size:18px;
        color:#e5e7eb;
        line-height:1.3;
        word-break:keep-all;
        overflow-wrap:anywhere; /* 길면 자동 줄바꿈 */
      }

      .site-status{ display:flex; align-items:center; gap:10px; margin-top:10px; }
      .light{
        width:14px; height:14px; border-radius:50%;
        box-shadow:0 0 0 2px rgba(255,255,255,.06) inset, 0 0 8px rgba(0,0,0,.25);
      }
      .light.success{ background:#10b981; box-shadow:0 0 0 2px rgba(255,255,255,.06) inset, 0 0 10px #10b98166; }
      .light.warning{ background:#f59e0b; box-shadow:0 0 0 2px rgba(255,255,255,.06) inset, 0 0 10px #f59e0b66; }
      .light.danger{  background:#ef4444; box-shadow:0 0 0 2px rgba(255,255,255,.06) inset, 0 0 10px #ef444466; }
      .light.inactive{background:#6b7280;}

      .site-status-text{ color:#cbd5e1; font-weight:700; }
      .site-status-text.muted{ color:#9ca3af; font-weight:500; }

      /* 테이블 내부 2단 막대 최소 스타일 */
      .progress-bar{ position:relative; background:#0e1424; border:1px solid #263147; border-radius:999px; height:14px; overflow:hidden; }
      .progress-fill{ height:100%; width:0%; transition: width .6s ease; }
      .progress-text{ display:inline-block; margin-left:8px; font-size:12px; color:#cbd5e1; }

      /* 관리메뉴 5열 그리드 (설정 추가) */
      .admin-menu {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-top: 16px;
      }
      @media (max-width: 1400px) { .admin-menu { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 900px)  { .admin-menu { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 600px)  { .admin-menu { grid-template-columns: 1fr; } }

      .menu-card {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 6px 20px rgba(0,0,0,.25);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
      }
      .menu-card h3 { margin: 0 0 8px 0; color: #e5e7eb; }
      .menu-card p  { flex: 1; font-size: 14px; color: #9ca3af; margin: 0 0 12px 0; }
      .menu-btn {
        background: #2563eb; color: #fff; border: none; border-radius: 8px;
        padding: 10px; font-weight: 600; cursor: pointer;
      }
      .menu-btn:hover { background:#1d4ed8; }
      .menu-btn.settings { background: #6b7280; }
      .menu-btn.settings:hover { background: #4b5563; }
      
      /* 진행/공정 셀: 왼쪽 막대 2줄, 오른쪽 요약문구 */
      .progress-cell{ display:flex; align-items:center; gap:14px; }
      .progress-bars{ flex:0 0 50%; max-width:50%; }
      .progress-stack{ display:grid; gap:6px; }

      /* 막대(이미 있으면 중복돼도 무방) */
      .progress-bar{ position:relative; background:#0e1424; border:1px solid #263147; border-radius:999px; height:14px; overflow:hidden; }
      .progress-fill{ height:100%; width:0%; transition: width .6s ease; }
      .progress-fill.progress{ background:#3b82f6; }   /* 파란: 진행률 */
      .progress-fill.schedule{ background:#ef4444; }   /* 빨간: 공정율 */

      /* 오른쪽 50% 텍스트 */
      .progress-summary{ flex:1 1 50%; color:#e5e7eb; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

      /* 좁은 화면에선 위/아래로 쌓기 */
      @media (max-width:900px){
        .progress-cell{ flex-direction:column; align-items:stretch; }
        .progress-bars{ flex:0 0 auto; max-width:none; }
        .progress-summary{ white-space:normal; }
      }
      /* 라벨(좌) + 막대(우) 2행 스택 — 라벨 폰트 높이에 맞춰 중앙정렬 */
      .pg-stack{
        display:grid;
        grid-template-columns: max-content 1fr; /* 라벨은 내용만큼, 막대는 남은 폭 */
        grid-auto-rows: 1.2em;                  /* 행 높이 = 라벨 글자 높이 */
        row-gap: .5em;                          /* 행 간격 */
        column-gap: 12px;
        align-items: center;                    /* 라벨/막대 세로 중앙 일치 */
      }
      .pg-label{
        font-weight:700; color:#e5e7eb; line-height:1.2;
        display:flex; align-items:center; justify-content:flex-end;
        min-width:4.5em; white-space:nowrap;
      }
      .pg-bar{
        height:1.2em; background:#0e1424; border:1px solid #263147;
        border-radius:999px; overflow:hidden; position:relative;
      }
      .pg-fill{ height:100%; width:0%; transition:width .6s ease; }
      .pg-fill.progress{ background:#3b82f6; }  /* 진행률(파란) */
      .pg-fill.schedule{ background:#ef4444; }  /* 공정율(빨간) */
      .pg-val{
        position:absolute; right:8px; top:50%; transform:translateY(-50%);
        font-size:12px; color:#e5e7eb; font-weight:700; pointer-events:none;
      }
      /* 좁은 화면에서는 라벨 위, 막대 아래로 1열 배치 */
      @media (max-width:900px){
        .pg-stack{ grid-template-columns: 1fr; grid-auto-rows:auto; }
        .pg-label{ justify-content:flex-start; margin-bottom:2px; }
        .pg-bar{ height:1.2em; }
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>관리자 대시보드</h1>
            <div class="header-info">
                <span class="admin-badge">관리자</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">로그아웃</a>
            </div>
        </div>

        <!-- 상단 현장 그리드 (4열) : 카드 클릭 → /admin/projects/edit/<project_name> -->
        <div class="site-grid">
          {% for project in dashboard_data %}
            <a class="site-card"
               href="{{ url_for('edit_project', project_name=project.project_name) }}"
               title="{{ project.project_name }} 상세로 이동">
              <div class="site-title">현장명 : {{ project.project_name }}</div>
              <div class="site-status">
                <span class="light
                  {{ 'success' if project.status_color=='success'
                     else ('warning' if project.status_color=='warning'
                           else ('danger' if project.status_color=='danger' else 'inactive')) }}"></span>
                <span class="site-status-text">
                  {{ project.status if project.status in ['양호','경고','위험'] else '상태 없음' }}
                </span>
              </div>
            </a>
          {% endfor %}

          {# 4의 배수로 칸 맞추기 위한 플레이스홀더 (빈 카드 회색불, 클릭 불가) #}
          {% set rem = (4 - (dashboard_data|length % 4)) if (dashboard_data|length % 4) != 0 else 0 %}
          {% for _ in range(rem) %}
            <div class="site-card inactive">
              <div class="site-title">현장명 :</div>
              <div class="site-status">
                <span class="light inactive"></span>
                <span class="site-status-text muted">대기</span>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- 프로젝트 현황 테이블 -->
        <div class="projects-overview">
            <h2>프로젝트 현황</h2>
            <div class="table-wrapper">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>프로젝트명</th>
                            <th>최근업데이트</th>
                            <th>공종수</th>
                            <th>금일출역</th>
                            <th>누계출역</th>
                            <th>진행률 / 공정율</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in dashboard_data %}
                        <tr>
                            <td class="project-name">{{ project.project_name }}</td>
                            <td>{{ project.recent_date }}</td>
                            <td>{{ project.work_count }}개</td>
                            <td class="number">{{ project.today_workers }}명</td>
                            <td class="number">{{ project.cumulative_workers }}명</td>
                           <td class="progress">
                              <div class="pg-stack">
                                <!-- 1행: 진행률 -->
                                <div class="pg-label">진행률</div>
                                <div class="pg-bar">
                                  <div class="pg-fill progress" data-progress="{{ project.avg_progress or 0 }}"></div>
                                  <span class="pg-val">{{ (project.avg_progress or 0)|round(1) }}%</span>
                                </div>
                                <!-- 2행: 공정율 -->
                                <div class="pg-label">공정율</div>
                                <div class="pg-bar">
                                  <div class="pg-fill schedule" data-progress="{{ project.schedule_rate or 0 }}"></div>
                                  <span class="pg-val">{{ (project.schedule_rate or 0)|round(1) }}%</span>
                                </div>
                              </div>
                            </td>
                            <td>
                                <span class="status-badge status-{{ project.status_color }}">
                                    {{ project.status }}
                                </span>
                            </td>
                            <td>
                                <button class="detail-btn"
                                        onclick="viewProject('{{ project.project_name }}')">상세보기</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 관리 메뉴 (5열 그리드 - 설정 추가) -->
        <div class="admin-menu-section">
            <h2>관리 메뉴</h2>
            <div class="admin-menu">
                <div class="menu-card">
                    <h3>노무비 설정</h3>
                    <p>공종별 노무비 단가 설정</p>
                    <button class="menu-btn" onclick="location.href='/admin/labor-cost'">설정하기</button>
                </div>
                
                <div class="menu-card">
                    <h3>프로젝트 관리</h3>
                    <p>프로젝트 생성 및 공종 설정</p>
                    <button class="menu-btn" onclick="location.href='/admin/projects'">관리하기</button>
                </div>
                
                <div class="menu-card">
                    <h3>사용자 관리</h3>
                    <p>사용자 계정 및 권한 관리</p>
                    <button class="menu-btn" onclick="location.href='/admin/users'">관리하기</button>
                </div>
                
                <div class="menu-card">
                    <h3>보고서</h3>
                    <p>데이터 분석 및 내보내기</p>
                    <button class="menu-btn" onclick="location.href='/admin/reports'">보고서</button>
                </div>

                <div class="menu-card">
                    <h3>설정</h3>
                    <p>테마 및 알고리즘 설정</p>
                    <button class="menu-btn settings" onclick="location.href='/admin/settings'">설정</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 막대 게이지 채우기 (0% 진행률은 width: 0%로 표시)
        document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.progress-fill, .pg-fill').forEach(function(elem) {
            const p = parseFloat(elem.getAttribute('data-progress') || '0');
            // 0% 이하는 표시 안함, 100% 초과는 100%로 제한
            const clamped = Math.max(0, Math.min(100, p));
            elem.style.width = clamped + '%';
          });
        });

        // 상세보기: 관리자 편집 페이지로 이동
        function viewProject(projectName) {
            const url = '/admin/projects/edit/' + encodeURIComponent(projectName);
            window.location.href = url;
        }
    </script>
</body>
</html>